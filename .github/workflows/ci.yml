name: CI
on: [push, pull_request]
jobs:
  ci:
    # run on external PRs, but not on internal PRs since those will be run by push to branch
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        target-platform: [ "JVM", "JS" ]
    env:
      JAVA_OPTS: "-Xmx4G"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Set up JDK 11 and sbt
      uses: laughedelic/coursier-setup@v1
      with:
        jvm: graalvm-ce-java11:20.3.0
        apps: sbt
    - name: Cache sbt
      uses: actions/cache@v2
      with:
        path: |
          ~/.sbt
          ~/.ivy2/cache
          ~/.coursier
        key: sbt-cache-${{ runner.os }}-${{ matrix.target-platform }}-${{ hashFiles('project/build.properties') }}
    - name: Compile
      run: sbt compile compileDocumentation
    - name: Test
      run: sbt 'mimaReportBinaryIssues test:compile' && sbt test${{ matrix.target-platform }}
    - name: Cleanup
      run: |
        rm -rf "$HOME/.ivy2/local" || true
        find $HOME/.ivy2/cache                       -name "ivydata-*.properties" -delete || true
        find $HOME/.ivy2/cache                       -name "*-LM-SNAPSHOT*"       -delete || true
        find $HOME/.cache/coursier/v1                -name "ivydata-*.properties" -delete || true
        find $HOME/.sbt                              -name "*.lock"               -delete || true

